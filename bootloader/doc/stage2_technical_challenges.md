# ç¬¬äºŒé˜¶æ®µæŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ¯ æ ¸å¿ƒæŠ€æœ¯æŒ‘æˆ˜

### æŒ‘æˆ˜1: ä»£ç å¤§å°é™åˆ¶
**é—®é¢˜**: ç¬¬ä¸€é˜¶æ®µå¿…é¡»æ§åˆ¶åœ¨512å­—èŠ‚å†…ï¼Œä½†éœ€è¦å®ç°virtioç£ç›˜è¯»å–åŠŸèƒ½

**è§£å†³æ–¹æ¡ˆ**:
1. **æœ€å°åŒ–åŠŸèƒ½**: ç¬¬ä¸€é˜¶æ®µåªå®ç°ç£ç›˜è¯»å–å’Œè·³è½¬
2. **å¤ç”¨å¯„å­˜å™¨**: å‡å°‘ä¸´æ—¶å˜é‡ï¼Œå……åˆ†åˆ©ç”¨RISC-Vå¯„å­˜å™¨
3. **å†…è”å‡½æ•°**: å…³é”®å‡½æ•°ä½¿ç”¨å†…è”æ±‡ç¼–é¿å…å‡½æ•°è°ƒç”¨å¼€é”€
4. **ç²¾ç®€é”™è¯¯å¤„ç†**: ç¬¬ä¸€é˜¶æ®µåªå¤„ç†è‡´å‘½é”™è¯¯

**å…·ä½“å®ç°ç­–ç•¥**:
```c
// åœ¨boot_stage1.cä¸­ä½¿ç”¨å†…è”æ±‡ç¼–å‡å°‘ä»£ç å¤§å°
static inline void uart_putc_fast(char c) {
    asm volatile (
        "li t0, 0x10000000\n"
        "sb %0, 0(t0)"
        : : "r"(c) : "t0"
    );
}
```

### æŒ‘æˆ˜2: virtioé©±åŠ¨ç®€åŒ–
**é—®é¢˜**: kernelçš„virtio_disk.cä½¿ç”¨ä¸­æ–­å’Œå¤æ‚çš„ç¼“å†²åŒºç®¡ç†ï¼Œbootloaderéœ€è¦ç®€åŒ–

**è§£å†³æ–¹æ¡ˆ**:
1. **åŒæ­¥è½®è¯¢æ¨¡å¼**: ä¸ä½¿ç”¨ä¸­æ–­ï¼Œé‡‡ç”¨è½®è¯¢ç­‰å¾…
2. **ç®€åŒ–é˜Ÿåˆ—ç®¡ç†**: åªä½¿ç”¨å¿…è¦çš„virtioé˜Ÿåˆ—åŠŸèƒ½
3. **å›ºå®šå†…å­˜åˆ†é…**: é¢„åˆ†é…å›ºå®šå¤§å°çš„é˜Ÿåˆ—å†…å­˜
4. **å•çº¿ç¨‹è®¿é—®**: é¿å…å¹¶å‘æ§åˆ¶å¤æ‚æ€§

**å…³é”®ä»£ç æ¨¡å¼**:
```c
// ç®€åŒ–çš„virtioåˆå§‹åŒ– - å»é™¤ä¸­æ–­å¤„ç†
int virtio_disk_boot_init(void) {
    // åªä¿ç•™è®¾å¤‡è¯†åˆ«å’Œé˜Ÿåˆ—é…ç½®
    // ç§»é™¤plicä¸­æ–­é…ç½®
    // ç§»é™¤spinlockæœºåˆ¶
}

// åŒæ­¥ç£ç›˜è¯»å– - è½®è¯¢è€Œéä¸­æ–­
int virtio_disk_read_sync(uint64 sector, void *buf) {
    // æäº¤è¯·æ±‚åè½®è¯¢ç­‰å¾…
    while(disk.used_idx == disk.used->idx) {
        // ç®€å•è½®è¯¢ï¼Œæ·»åŠ è¶…æ—¶æœºåˆ¶
    }
}
```

### æŒ‘æˆ˜3: å†…å­˜å¸ƒå±€ç®¡ç†
**é—®é¢˜**: ç¬¬ä¸€é˜¶æ®µã€ç¬¬äºŒé˜¶æ®µã€virtioé˜Ÿåˆ—ã€å†…æ ¸åŠ è½½éœ€è¦ç²¾ç¡®çš„å†…å­˜è§„åˆ’

**è§£å†³æ–¹æ¡ˆ**:
1. **åˆ†æ®µå¼å†…å­˜ç®¡ç†**: ä¸åŒåŠŸèƒ½ä½¿ç”¨ä¸åŒå†…å­˜æ®µ
2. **é¡µå¯¹é½åˆ†é…**: virtioè¦æ±‚é¡µå¯¹é½çš„é˜Ÿåˆ—å†…å­˜
3. **é¢„ç•™ç¼“å†²åŒº**: ä¸ºå†…æ ¸åŠ è½½é¢„ç•™è¶³å¤Ÿç©ºé—´
4. **åœ°å€æ£€æŸ¥**: åœ¨è¿è¡Œæ—¶éªŒè¯åœ°å€ä¸å†²çª

**å†…å­˜æ˜ å°„è®¾è®¡**:
```
0x80000000 (4KB)   ç¬¬ä¸€é˜¶æ®µä»£ç +æ ˆ
0x80001000 (32KB)  ç¬¬äºŒé˜¶æ®µä»£ç 
0x80010000 (64KB)  bootloaderå †å†…å­˜
0x80020000 (64KB)  ç¬¬äºŒé˜¶æ®µæ ˆ
0x80030000 (64KB)  I/Oç¼“å†²åŒº
0x80040000         é¢„ç•™ç©ºé—´
0x80200000         å†…æ ¸åŠ è½½åŒºåŸŸ
```

### æŒ‘æˆ˜4: ä¸¤é˜¶æ®µè·³è½¬æœºåˆ¶
**é—®é¢˜**: å¦‚ä½•ä»ç¬¬ä¸€é˜¶æ®µå®‰å…¨åœ°è·³è½¬åˆ°ç¬¬äºŒé˜¶æ®µï¼Œä¿æŒçŠ¶æ€è¿ç»­æ€§

**è§£å†³æ–¹æ¡ˆ**:
1. **çŠ¶æ€ä¼ é€’**: é€šè¿‡å›ºå®šå†…å­˜ä½ç½®ä¼ é€’å¿…è¦ä¿¡æ¯
2. **æ ˆåˆ‡æ¢**: ç¬¬äºŒé˜¶æ®µä½¿ç”¨ç‹¬ç«‹çš„æ ˆç©ºé—´
3. **è®¾å¤‡çŠ¶æ€ä¿æŒ**: virtioè®¾å¤‡åˆå§‹åŒ–çŠ¶æ€åœ¨è·³è½¬åä¿æŒ
4. **é”™è¯¯æ¢å¤**: å¦‚æœç¬¬äºŒé˜¶æ®µåŠ è½½å¤±è´¥ï¼Œèƒ½å¤Ÿå›åˆ°ç¬¬ä¸€é˜¶æ®µ

**è·³è½¬å®ç°**:
```assembly
# åœ¨boot.Sä¸­çš„è·³è½¬é€»è¾‘
load_stage2_success:
    # è®¾ç½®ç¬¬äºŒé˜¶æ®µå‚æ•° (é€šè¿‡å¯„å­˜å™¨ä¼ é€’)
    li a0, 0x80001000    # ç¬¬äºŒé˜¶æ®µå…¥å£åœ°å€
    li a1, 0x80020000    # ç¬¬äºŒé˜¶æ®µæ ˆåœ°å€
    
    # è·³è½¬åˆ°ç¬¬äºŒé˜¶æ®µ
    jr a0
```

## ğŸ”§ å…³é”®æŠ€æœ¯å®ç°

### æŠ€æœ¯ç‚¹1: virtioè½®è¯¢æœºåˆ¶
**kernelä¸­çš„ä¸­æ–­æ–¹å¼**:
```c
// kernel/virtio_disk.c - ä½¿ç”¨ä¸­æ–­
void virtio_disk_rw(struct buf *b, int write) {
    // ... è®¾ç½®è¯·æ±‚
    // ç­‰å¾…ä¸­æ–­ - sleep(&disk.free[0], &disk.vdisk_lock);
}
```

**bootloaderä¸­çš„è½®è¯¢æ–¹å¼**:
```c
// bootloaderç®€åŒ–ç‰ˆæœ¬ - ä½¿ç”¨è½®è¯¢
int virtio_disk_read_sync(uint64 sector, void *buf) {
    // ... è®¾ç½®è¯·æ±‚
    
    // è½®è¯¢ç­‰å¾…å®Œæˆ
    int timeout = 1000000;
    while(disk.used_idx == disk.used->idx && timeout > 0) {
        timeout--;
        // å¯ä»¥æ·»åŠ çŸ­æš‚å»¶è¿Ÿ
        for(int i = 0; i < 100; i++) {
            asm volatile("nop");
        }
    }
    
    if(timeout == 0) {
        return BOOT_ERROR_TIMEOUT;
    }
    
    // æ£€æŸ¥ç»“æœ...
}
```

### æŠ€æœ¯ç‚¹2: å†…å­˜åˆ†é…ç­–ç•¥
**kernelä¸­çš„é¡µåˆ†é…**:
```c
// kernelä½¿ç”¨å¤æ‚çš„é¡µåˆ†é…å™¨
void* kalloc(void) {
    // å¤æ‚çš„ç©ºé—²é“¾è¡¨ç®¡ç†
}
```

**bootloaderä¸­çš„ç®€åŒ–åˆ†é…**:
```c
// bootloaderä½¿ç”¨çº¿æ€§åˆ†é…å™¨
void *boot_alloc(int size) {
    static char *heap_ptr = (char *)BOOTLOADER_HEAP;
    void *result = heap_ptr;
    heap_ptr += (size + 7) & ~7;  // 8å­—èŠ‚å¯¹é½
    return result;
}
```

### æŠ€æœ¯ç‚¹3: é”™è¯¯å¤„ç†ç­–ç•¥
**kernelä¸­çš„panicæœºåˆ¶**:
```c
void panic(char *s) {
    // å¤æ‚çš„panicå¤„ç†ï¼ŒåŒ…æ‹¬backtrace
}
```

**bootloaderä¸­çš„ç®€åŒ–é”™è¯¯å¤„ç†**:
```c
void boot_panic(const char *msg) {
    uart_puts("\n*** BOOT PANIC: ");
    uart_puts(msg);
    uart_puts(" ***\n");
    
    while(1) {
        asm volatile("wfi");
    }
}
```

## ğŸ“Š æ€§èƒ½å’Œèµ„æºåˆ†æ

### ä»£ç å¤§å°é¢„ä¼°
| æ¨¡å— | é¢„ä¼°å¤§å° | é™åˆ¶ | ç­–ç•¥ |
|------|----------|------|------|
| stage1/boot.S | 40å­—èŠ‚ | 512å­—èŠ‚ | æ±‡ç¼–ä¼˜åŒ– |
| stage1/boot_stage1.c | 300å­—èŠ‚ | | å†…è”å‡½æ•° |
| common/uart.c | 150å­—èŠ‚ | | å¿…è¦åŠŸèƒ½ |
| common/virtio_boot.c | 2KB | | ç¬¬äºŒé˜¶æ®µä¸»è¦éƒ¨åˆ† |
| stage2/main.c | 1KB | 32KB | åŠŸèƒ½å®Œæ•´ |

### å†…å­˜ä½¿ç”¨é¢„ä¼°
| ç”¨é€” | å¤§å° | åœ°å€èŒƒå›´ | è¯´æ˜ |
|------|------|----------|------|
| virtioé˜Ÿåˆ— | 12KB | 0x80010000-0x80012FFF | é¡µå¯¹é½ |
| å †å†…å­˜ | 50KB | 0x80013000-0x8001FFFF | åŠ¨æ€åˆ†é… |
| æ ˆå†…å­˜ | 64KB | 0x80020000-0x8002FFFF | ç¬¬äºŒé˜¶æ®µæ ˆ |
| I/Oç¼“å†² | 64KB | 0x80030000-0x8003FFFF | ç£ç›˜è¯»å– |

### å¯åŠ¨æ—¶é—´åˆ†æ
| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | ä¸»è¦è€—æ—¶ | ä¼˜åŒ–ç­–ç•¥ |
|------|----------|----------|----------|
| ç¬¬ä¸€é˜¶æ®µå¯åŠ¨ | 50ms | UARTè¾“å‡º | å‡å°‘è°ƒè¯•ä¿¡æ¯ |
| virtioåˆå§‹åŒ– | 100ms | è®¾å¤‡æ¡æ‰‹ | ç®€åŒ–ç‰¹æ€§åå•† |
| ç¬¬äºŒé˜¶æ®µåŠ è½½ | 200ms | ç£ç›˜I/O | æ‰¹é‡è¯»å– |
| å†…æ ¸åŠ è½½ | 500ms | å¤§é‡ç£ç›˜I/O | ä¼˜åŒ–è¯»å–ç­–ç•¥ |
| **æ€»è®¡** | **<1ç§’** | | |

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### å•å…ƒæµ‹è¯•
1. **å†…å­˜åˆ†é…å™¨æµ‹è¯•**
   ```c
   void test_memory_allocator(void) {
       void *p1 = boot_alloc(100);
       void *p2 = boot_alloc(200);
       // éªŒè¯åœ°å€ä¸é‡å ï¼Œå¯¹é½æ­£ç¡®
   }
   ```

2. **virtioè®¾å¤‡æµ‹è¯•**
   ```c
   void test_virtio_init(void) {
       int result = virtio_disk_boot_init();
       // éªŒè¯è¿”å›æˆåŠŸï¼Œè®¾å¤‡çŠ¶æ€æ­£ç¡®
   }
   ```

3. **ç£ç›˜è¯»å–æµ‹è¯•**
   ```c
   void test_disk_read(void) {
       char buf[512];
       int result = virtio_disk_read_sync(0, buf);
       // éªŒè¯è¯»å–æˆåŠŸï¼Œæ•°æ®æ­£ç¡®
   }
   ```

### é›†æˆæµ‹è¯•
1. **ä¸¤é˜¶æ®µå¯åŠ¨æµ‹è¯•**: éªŒè¯å®Œæ•´å¯åŠ¨æµç¨‹
2. **é”™è¯¯æ¢å¤æµ‹è¯•**: æ¨¡æ‹Ÿå„ç§é”™è¯¯åœºæ™¯
3. **å†…å­˜å†²çªæµ‹è¯•**: éªŒè¯å†…å­˜å¸ƒå±€å®‰å…¨
4. **æ€§èƒ½å‹åŠ›æµ‹è¯•**: å¤§é‡ç£ç›˜è¯»å–æ“ä½œ

## ğŸ“‹ è´¨é‡æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡
- [ ] æ‰€æœ‰å‡½æ•°éƒ½æœ‰è¯¦ç»†æ³¨é‡Š
- [ ] é”™è¯¯ç ç»Ÿä¸€ä½¿ç”¨å®šä¹‰çš„å¸¸é‡
- [ ] å†…å­˜è®¿é—®éƒ½æœ‰è¾¹ç•Œæ£€æŸ¥
- [ ] æ±‡ç¼–ä»£ç æœ‰å……åˆ†çš„æ³¨é‡Š
- [ ] Cä»£ç éµå¾ªkernelçš„ç¼–ç é£æ ¼

### åŠŸèƒ½å®Œæ•´æ€§
- [ ] èƒ½å¤Ÿä»virtioç£ç›˜å¯åŠ¨
- [ ] ä¸¤é˜¶æ®µåŠ è½½æµç¨‹å®Œæ•´
- [ ] åŸºæœ¬çš„é”™è¯¯è¯Šæ–­å’Œæ¢å¤
- [ ] å……åˆ†çš„è°ƒè¯•è¾“å‡ºä¿¡æ¯

### ç¨³å®šæ€§
- [ ] å¤šæ¬¡å¯åŠ¨æµ‹è¯•æ— å¼‚å¸¸
- [ ] å„ç§é”™è¯¯åœºæ™¯å¤„ç†æ­£ç¡®
- [ ] å†…å­˜ä½¿ç”¨æ— æ³„æ¼æˆ–è¶Šç•Œ
- [ ] è®¾å¤‡çŠ¶æ€ç®¡ç†æ­£ç¡®

### å¯ç»´æŠ¤æ€§
- [ ] ä»£ç ç»“æ„æ¸…æ™°åˆ†å±‚
- [ ] æ¥å£å®šä¹‰æ˜ç¡®
- [ ] æ–‡æ¡£å®Œæ•´å‡†ç¡®
- [ ] æ„å»ºç³»ç»Ÿæ˜“ç”¨

---
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æŠ€æœ¯å®¡æŸ¥**: å¾…å®Œæˆ  
**æœ€åæ›´æ–°**: 2025å¹´9æœˆ2æ—¥
